ROOT_DIR = ../../..
CC = gcc
CXX = g++
WFLAGS = -Wall \
	-Wunused \
	-Wimplicit \
	-Wreturn-type \
	-Wmissing-prototypes \
	-Wmissing-declarations \
	-Wparentheses \
	-Wswitch \
	-Wtrigraphs \
	-Wpointer-arith \
	-Wcast-qual \
	-Wcast-align \
	-Wwrite-strings \
	-Wdeclaration-after-statement \
	-Wno-parentheses-equality
DFLAGS = -DHAVE_CONFIG_H \
	-DNO_DEBUG \
	-DU_STATIC_IMPLEMENTATION \
	-DGRAPHITE2_STATIC \
	-D__SyncTeX__ \
	'-DSYNCTEX_ENGINE_H="synctex-xetex.h"' 	# note the single quote matters here
IFLAGS = -I. \
	-I$(ROOT_DIR)/source/texk/web2c \
	-I$(ROOT_DIR)/build/texk \
	-I$(ROOT_DIR)/source/texk \
	-I$(ROOT_DIR)/source/texk/web2c/xetexdir \
	-I$(ROOT_DIR)/build/libs/icu/include \
	-I$(ROOT_DIR)/build/libs/freetype2/freetype2 \
	-I$(ROOT_DIR)/build/libs/teckit/include \
	-I$(ROOT_DIR)/build/libs/harfbuzz/include \
	-I$(ROOT_DIR)/build/libs/graphite2/include \
	-I$(ROOT_DIR)/build/libs/poppler/include \
	-I$(ROOT_DIR)/build/libs/libpng/include \
	-I$(ROOT_DIR)/build/libs/zlib/include \
	-I$(ROOT_DIR)/source/texk/web2c/libmd5 \
	-I$(ROOT_DIR)/source/texk/web2c/synctexdir \
	-I./w2c \
	-I/usr/include \
	-isystem /usr/include/x86_64-linux-gnu/ \
	-I/usr/include/uuid \
	-I/usr/include/freetype2 \
	-I/usr/include/libpng16 
CCFLAGS = $(WFLAGS) \
	$(DFLAGS) \
	$(IFLAGS) \
	-g \
	-O0 \

prepare:
	# xetex files
	cp $(ROOT_DIR)/source/texk/web2c/xetexdir/xetexextra.c xetexdir/
	cp $(ROOT_DIR)/source/texk/web2c/synctexdir/synctex.c synctexdir/

	# libmd5 files
	cp $(ROOT_DIR)/source/texk/web2c/libmd5/md5.c libmd5/

	# lib/lib.a files
	cp $(ROOT_DIR)/source/texk/web2c/lib/*.c lib/
	cp $(ROOT_DIR)/source/texk/web2c/lib/*.h lib/

	# libxetex files
	cp $(ROOT_DIR)/source/texk/web2c/xetexdir/*.h xetexdir/
	cp $(ROOT_DIR)/source/texk/web2c/xetexdir/*.c xetexdir/
	cp $(ROOT_DIR)/source/texk/web2c/xetexdir/*.cpp xetexdir/
	cp -r $(ROOT_DIR)/source/texk/web2c/xetexdir/image xetexdir/

xetex_sources = xetexdir/xetexextra.c \
	synctexdir/synctex.c \
	xetexini.c \
	xetex0.c \
	xetex-pool.c

xetex_objects = $(xetex_sources:.c=.o)

$(xetex_objects): %.o: %.c
	$(CC) $(CCFLAGS) -c -o $@ $<

libmd5_sources = libmd5/md5.c

libmd5_objects = $(libmd5_sources:.c=.o)

$(libmd5_objects): %.o: %.c
	$(CC) $(CCFLAGS) -c -o $@ $<

liba_sources = lib/alloca.c \
	lib/coredump.c \
	lib/fprintreal.c \
	lib/inputint.c \
	lib/printversion.c \
	lib/setupvar.c \
	lib/uexit.c \
	lib/version.c \
	lib/basechsuffix.c \
	lib/chartostring.c \
	lib/eofeoln.c \
	lib/input2int.c \
	lib/openclose.c \
	lib/usage.c \
	lib/zround.c

liba_objects = $(liba_sources:.c=.o)

$(liba_objects): %.o: %.c
	$(CC) $(CCFLAGS) -c -o $@ $<

libxetex_cc_sources = xetexdir/XeTeX_ext.c \
	xetexdir/XeTeX_pic.c \
	xetexdir/trans.c \
	xetexdir/image/bmpimage.c \
	xetexdir/image/jpegimage.c \
	xetexdir/image/mfileio.c \
	xetexdir/image/numbers.c \
	xetexdir/image/pngimage.c

libxetex_cc_objects = $(libxetex_cc_sources:.c=.o)

$(libxetex_cc_objects): %.o: %.c
	$(CC) $(CCFLAGS) -c -o $@ $<

libxetex_cxx_sources = xetexdir/XeTeXFontInst.cxx \
	xetexdir/XeTeXFontMgr.cxx \
	xetexdir/XeTeXLayoutInterface.cxx \
	xetexdir/XeTeXOTMath.cxx \
	xetexdir/hz.cxx \
	xetexdir/pdfimage.cxx \
	xetexdir/XeTeXFontMgr_FC.cxx

libxetex_cxx_objects = $(libxetex_cxx_sources:.cxx=.o)

$(libxetex_cxx_objects): %.o: %.cpp
	$(CXX) $(CCFLAGS) -c -o $@ $<

libxetex_objects = $(libxetex_cc_objects) $(libxetex_cxx_objects)

xetex: prepare $(xetex_objects) $(libmd5_objects) $(liba_objects) $(libxetex_objects)
	# note that the order of `.a` files matters here, namely, if you put
	# `lib/lib.a` after `libkpathsea.a`, this command will report an error
	$(CXX) \
	-g \
	-O2 \
	-o xetex \
	$(xetex_objects) \
	$(libxetex_objects) \
	$(libmd5_objects) \
	$(liba_objects) \
	$(ROOT_DIR)/build/libs/harfbuzz/libharfbuzz.a \
	$(ROOT_DIR)/build/libs/graphite2/libgraphite2.a \
	$(ROOT_DIR)/build/libs/icu/icu-build/lib/libicuuc.a \
	$(ROOT_DIR)/build/libs/icu/icu-build/lib/libicudata.a \
	$(ROOT_DIR)/build/libs/teckit/libTECkit.a \
	$(ROOT_DIR)/build/libs/poppler/libpoppler.a \
	$(ROOT_DIR)/build/libs/libpng/libpng.a \
	$(ROOT_DIR)/build/libs/freetype2/libfreetype.a \
	$(ROOT_DIR)/build/libs/zlib/libz.a \
	$(ROOT_DIR)/build/texk/kpathsea/.libs/libkpathsea.a \
	-lfontconfig \
	-lfreetype \
	-lm \
	-lstdc++ \
	-lc \
	-lgcc_eh \
	-lgcc \
	-nodefaultlibs