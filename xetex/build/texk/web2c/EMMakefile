ROOT_DIR = ../../..
CC = gcc
CXX = g++
WFLAGS = -Wall \
	-Wunused \
	-Wimplicit \
	-Wreturn-type \
	-Wmissing-prototypes \
	-Wmissing-declarations \
	-Wparentheses \
	-Wswitch \
	-Wtrigraphs \
	-Wpointer-arith \
	-Wcast-qual \
	-Wcast-align \
	-Wwrite-strings \
	-Wdeclaration-after-statement \
	-Wno-parentheses-equality
DFLAGS = -DHAVE_CONFIG_H \
	-DNO_DEBUG \
	-DU_STATIC_IMPLEMENTATION \
	-DGRAPHITE2_STATIC \
	-D__SyncTeX__ \
	'-DSYNCTEX_ENGINE_H="synctex-xetex.h"' 	# note the single quote matters here
IFLAGS = -I. \
	-I$(ROOT_DIR)/source/texk/web2c \
	-I$(ROOT_DIR)/build/texk \
	-I$(ROOT_DIR)/source/texk \
	-I$(ROOT_DIR)/source/texk/web2c/xetexdir \
	-I$(ROOT_DIR)/build/libs/icu/include \
	-I$(ROOT_DIR)/build/libs/freetype2/freetype2 \
	-I$(ROOT_DIR)/build/libs/teckit/include \
	-I$(ROOT_DIR)/build/libs/harfbuzz/include \
	-I$(ROOT_DIR)/build/libs/graphite2/include \
	-I$(ROOT_DIR)/build/libs/poppler/include \
	-I$(ROOT_DIR)/build/libs/libpng/include \
	-I$(ROOT_DIR)/build/libs/zlib/include \
	-I$(ROOT_DIR)/source/texk/web2c/libmd5 \
	-I$(ROOT_DIR)/source/texk/web2c/synctexdir \
	-I./w2c \
	-I/usr/include \
	-isystem /usr/include/x86_64-linux-gnu/ \
	-I/usr/include/uuid \
	-I/usr/include/freetype2 \
	-I/usr/include/libpng16 
CCFLAGS = $(WFLAGS) \
	$(DFLAGS) \
	$(IFLAGS) \
	-g \
	-O0 \

prepare:
	cp $(ROOT_DIR)/source/texk/web2c/xetexdir/xetexextra.c xetexdir/
	cp $(ROOT_DIR)/source/texk/web2c/synctexdir/synctex.c synctexdir/

xetex_sources = xetexdir/xetexextra.c \
	synctexdir/synctex.c \
	xetexini.c \
	xetex0.c \
	xetex-pool.c

xetex_objects = $(xetex_sources:.c=.o)

$(xetex_objects): %.o: %.c
	$(CC) $(CCFLAGS) -c -o $@ $<

xetex: prepare $(xetex_objects)
	# note that the order of `.a` files matters here, namely, if you put
	# `lib/lib.a` after `libkpathsea.a`, this command will report an error
	$(CXX) \
	-g \
	-O2 \
	-o xetex \
	$(xetex_objects) \
	libxetex.a \
	libmd5.a \
	lib/lib.a \
	$(ROOT_DIR)/build/libs/harfbuzz/libharfbuzz.a \
	$(ROOT_DIR)/build/libs/graphite2/libgraphite2.a \
	$(ROOT_DIR)/build/libs/icu/icu-build/lib/libicuuc.a \
	$(ROOT_DIR)/build/libs/icu/icu-build/lib/libicudata.a \
	$(ROOT_DIR)/build/libs/teckit/libTECkit.a \
	$(ROOT_DIR)/build/libs/poppler/libpoppler.a \
	$(ROOT_DIR)/build/libs/libpng/libpng.a \
	$(ROOT_DIR)/build/libs/freetype2/libfreetype.a \
	$(ROOT_DIR)/build/libs/zlib/libz.a \
	$(ROOT_DIR)/build/texk/kpathsea/.libs/libkpathsea.a \
	-lfontconfig \
	-lfreetype \
	-lm \
	-lstdc++ \
	-lc \
	-lgcc_eh \
	-lgcc \
	-nodefaultlibs